name: CI

on:
  push:
    branches:
      - "**" # All branches
  pull_request:
    branches:
      - "**" # All branches
  workflow_dispatch:
    inputs:
      test_prod_build:
        description: "Test production build (ignores branch condition)"
        required: false
        type: boolean
        default: false

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Type check (tsc)
        run: npm run typecheck

      - name: ğŸ§¹ Lint code (ESLint)
        run: npm run lint

      - name: ğŸ’… Check formatting (Prettier)
        run: npm run format:check

      - name: ğŸ§ª Run unit tests (Vitest)
        run: npm run test:unit

      - name: ğŸ”— Run integration tests (Vitest)
        run: npm run test:integration

  build-dev:
    name: Build (Development)
    runs-on: ubuntu-latest
    needs: [test]
    # Only build dev artifacts for non-main branches
    if: github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    environment:
      name: development
    env:
      GOOGLE_CLIENT_ID_DEV: ${{ secrets.GOOGLE_CLIENT_ID_DEV }}

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Build plugin (development)
        run: npm run build:dev

      - name: ğŸ“ Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: obsidian-syncer-dev
          path: |
            main.js
            manifest.json
            styles.css

  build-prod:
    name: Build (Production)
    runs-on: ubuntu-latest
    needs: [test]
    # Only build production artifacts on main branch, or when manually triggered with test_prod_build
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_prod_build == 'true')
    environment:
      name: production
    env:
      GOOGLE_CLIENT_ID_PROD: ${{ secrets.GOOGLE_CLIENT_ID_PROD }}

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Build plugin (production)
        run: npm run build:prod

      - name: ğŸ“ Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: obsidian-syncer-prod
          path: |
            main.js
            manifest.json
            styles.css
